# Docker Compose for Coolify deployment
# PostgreSQL is managed separately by Coolify - don't include it here
#
# Coolify Setup:
# 1. Create a PostgreSQL database resource in Coolify
# 2. Note the connection string (DATABASE_URL)
# 3. Deploy this compose file as a Docker Compose resource
# 4. Set environment variables in Coolify's UI
# 5. Connect to your GitHub repo for auto-deploy on push

services:
  # Node.js frontend + backend
  node:
    build:
      context: .
      dockerfile: Dockerfile.node
    expose:
      - "3000"
    environment:
      - NODE_ENV=production
      - PORT=3000
      # Database (set in Coolify UI)
      - DATABASE_URL=${DATABASE_URL}
      # JWT Secret (set in Coolify UI)
      - JWT_SECRET=${JWT_SECRET}
      # LLM Configuration (set in Coolify UI)
      - LLM_PROVIDER=${LLM_PROVIDER:-openai}
      - LLM_MODEL=${LLM_MODEL:-}
      - LLM_API_KEY=${LLM_API_KEY:-}
      - OPENAI_API_KEY=${OPENAI_API_KEY:-}
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY:-}
      - MINIMAX_API_KEY=${MINIMAX_API_KEY:-}
      - MINIMAX_GROUP_ID=${MINIMAX_GROUP_ID:-}
      - OLLAMA_HOST=${OLLAMA_HOST:-}
      # Orchestrator URL (internal docker network)
      - ORCHESTRATOR_URL=http://orchestrator:8001
    depends_on:
      - orchestrator
    restart: unless-stopped
    networks:
      - manus-network
    healthcheck:
      test:
        [
          "CMD",
          "wget",
          "--no-verbose",
          "--tries=1",
          "--spider",
          "http://localhost:3000/health",
        ]
      interval: 30s
      timeout: 10s
      start_period: 60s
      retries: 3

  # Python orchestrator service
  orchestrator:
    build:
      context: ./services/orchestrator
      dockerfile: Dockerfile
    environment:
      - PORT=8001
      # Database (set in Coolify UI - same as node service)
      - DATABASE_URL=${DATABASE_URL}
      # LLM API keys (set in Coolify UI)
      - OPENAI_API_KEY=${OPENAI_API_KEY:-}
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY:-}
      - MINIMAX_API_KEY=${MINIMAX_API_KEY:-}
    restart: unless-stopped
    networks:
      - manus-network
    healthcheck:
      test:
        [
          "CMD",
          "python",
          "-c",
          "import urllib.request; urllib.request.urlopen('http://localhost:8001/health')",
        ]
      interval: 30s
      timeout: 10s
      start_period: 15s
      retries: 3

networks:
  manus-network:
    driver: bridge
